<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Whisper Sandbox — VerificaEC</title>
  <!-- Whisper.js via transformers.js CDN -->
  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js';

    let transcriber = null;

    async function loadModel() {
      transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny', {
        language: 'es',
        task: 'transcribe'
      });
      window.parent.postMessage({ type: 'WHISPER_READY' }, '*');
    }

    window.addEventListener('message', async (event) => {
      if (event.data.type === 'TRANSCRIBE_AUDIO') {
        if (!transcriber) {
          await loadModel();
        }
        try {
          const result = await transcriber(event.data.audioData, {
            language: 'es',
            task: 'transcribe',
            return_timestamps: true
          });
          window.parent.postMessage({
            type: 'TRANSCRIPTION_RESULT',
            text: result.text,
            chunks: result.chunks
          }, '*');
        } catch (err) {
          window.parent.postMessage({ type: 'TRANSCRIPTION_ERROR', error: err.message }, '*');
        }
      }

      if (event.data.type === 'LOAD_WHISPER') {
        loadModel();
      }
    });
  </script>
</head>
<body>
  <p style="font-family:sans-serif;color:#666;font-size:12px;padding:10px">
    Sandbox de transcripción local (Whisper.js) — VerificaEC
  </p>
</body>
</html>
